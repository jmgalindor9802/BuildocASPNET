@using Microsoft.AspNetCore.Identity
@using Buildoc.Models
@inject SignInManager<Usuario> SignInManager
@inject UserManager<Usuario> UserManager

<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>AdminLTE 3 | Blank Page</title>

	<!-- Google Font: Source Sans Pro -->
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
	<!-- Font Awesome -->
	<link rel="stylesheet" href="/AdminLTE/plugins/fontawesome-free/css/all.min.css">
	<!-- DataTables -->
	<link rel="stylesheet" href="/AdminLTE/plugins/datatables-bs4/css/dataTables.bootstrap4.min.css">
	<link rel="stylesheet" href="/AdminLTE/plugins/datatables-responsive/css/responsive.bootstrap4.min.css">
	<link rel="stylesheet" href="/AdminLTE/plugins/datatables-buttons/css/buttons.bootstrap4.min.css">
	<!-- Theme style -->
	<link rel="stylesheet" href="/AdminLTE/css/adminlte.min.css">

	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/css/toastr.min.css">
	<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/js/toastr.min.js"></script>

</head>
<body class="hold-transition sidebar-mini">

	<!-- Site wrapper -->
	<div class="wrapper">
		<!-- Navbar -->
		<nav class="main-header navbar navbar-expand navbar-white navbar-light">
			<!-- Left navbar links -->

			<ul class="navbar-nav">
				<li class="nav-item">
					<a class="nav-link" data-widget="pushmenu" href="#" role="button"><i class="fas fa-bars"></i></a>
				</li>
				<li class="nav-item">

					<img src="/logo_buildoc_color.png" alt="Buildoc Logo" class="brand-image  " style="opacity: .8; width: 100px; height: auto;">

				</li>

			</ul>

			<!-- Right navbar links -->
			<ul class="navbar-nav ml-auto">
				<!-- Navbar Search -->
				<li class="nav-item">
					<a class="nav-link" data-widget="navbar-search" href="#" role="button">
						<i class="fas fa-search"></i>
					</a>
					<div class="navbar-search-block">
						<form class="form-inline">
							<div class="input-group input-group-sm">
								<input class="form-control form-control-navbar" type="search" placeholder="Buscar" aria-label="Search">
								<div class="input-group-append">
									<button class="btn btn-navbar" type="submit">
										<i class="fas fa-search"></i>
									</button>
									<button class="btn btn-navbar" type="button" data-widget="navbar-search">
										<i class="fas fa-times"></i>
									</button>
								</div>
							</div>
						</form>
					</div>
				</li>

				<!-- Messages Dropdown Menu -->
				<li class="nav-item dropdown">
					<a class="nav-link" data-toggle="dropdown" href="#">
						<i class="far fa-comments"></i>
						<span class="badge badge-danger navbar-badge">3</span>
					</a>
					<div class="dropdown-menu dropdown-menu-lg dropdown-menu-right">
						<a href="#" class="dropdown-item">
							<!-- Message Start -->
							<div class="media">
								<img src="../../dist/img/user1-128x128.jpg" alt="User Avatar" class="img-size-50 mr-3 img-circle">
								<div class="media-body">
									<h3 class="dropdown-item-title">
										Brad Diesel
										<span class="float-right text-sm text-danger"><i class="fas fa-star"></i></span>
									</h3>
									<p class="text-sm">Call me whenever you can...</p>
									<p class="text-sm text-muted"><i class="far fa-clock mr-1"></i> 4 Hours Ago</p>
								</div>
							</div>
							<!-- Message End -->
						</a>
						<div class="dropdown-divider"></div>
						<a href="#" class="dropdown-item">
							<!-- Message Start -->
							<div class="media">
								<img src="../../dist/img/user8-128x128.jpg" alt="User Avatar" class="img-size-50 img-circle mr-3">
								<div class="media-body">
									<h3 class="dropdown-item-title">
										John Pierce
										<span class="float-right text-sm text-muted"><i class="fas fa-star"></i></span>
									</h3>
									<p class="text-sm">I got your message bro</p>
									<p class="text-sm text-muted"><i class="far fa-clock mr-1"></i> 4 Hours Ago</p>
								</div>
							</div>
							<!-- Message End -->
						</a>
						<div class="dropdown-divider"></div>
						<a href="#" class="dropdown-item">
							<!-- Message Start -->
							<div class="media">
								<img src="../../dist/img/user3-128x128.jpg" alt="User Avatar" class="img-size-50 img-circle mr-3">
								<div class="media-body">
									<h3 class="dropdown-item-title">
										Nora Silvester
										<span class="float-right text-sm text-warning"><i class="fas fa-star"></i></span>
									</h3>
									<p class="text-sm">The subject goes here</p>
									<p class="text-sm text-muted"><i class="far fa-clock mr-1"></i> 4 Hours Ago</p>
								</div>
							</div>
							<!-- Message End -->
						</a>
						<div class="dropdown-divider"></div>
						<a href="#" class="dropdown-item dropdown-footer">See All Messages</a>
					</div>
				</li>
				<!-- Notifications Dropdown Menu -->
				<li class="nav-item dropdown">
					<a class="nav-link" data-toggle="dropdown" href="#">
						<i class="far fa-bell"></i>
						<span class="badge badge-warning navbar-badge">15</span>
					</a>
					<div class="dropdown-menu dropdown-menu-lg dropdown-menu-right">
						<span class="dropdown-item dropdown-header">15 Notifications</span>
						<div class="dropdown-divider"></div>
						<a href="#" class="dropdown-item">
							<i class="fas fa-envelope mr-2"></i> 4 new messages
							<span class="float-right text-muted text-sm">3 mins</span>
						</a>
						<div class="dropdown-divider"></div>
						<a href="#" class="dropdown-item">
							<i class="fas fa-users mr-2"></i> 8 friend requests
							<span class="float-right text-muted text-sm">12 hours</span>
						</a>
						<div class="dropdown-divider"></div>
						<a href="#" class="dropdown-item">
							<i class="fas fa-file mr-2"></i> 3 new reports
							<span class="float-right text-muted text-sm">2 days</span>
						</a>
						<div class="dropdown-divider"></div>
						<a href="#" class="dropdown-item dropdown-footer">See All Notifications</a>
					</div>
				</li>
				<li class="nav-item">
					<a class="nav-link" data-widget="fullscreen" href="#" role="button">
						<i class="fas fa-expand-arrows-alt"></i>
					</a>
				</li>
				<li class="nav-item">
					<a class="nav-link" data-widget="control-sidebar" data-slide="true" href="#" role="button">
						<i class="fas fa-th-large"></i>
					</a>
				</li>
			</ul>
			<partial name="_LoginPartial" />
		</nav>
		<!-- /.navbar -->
		<!-- Main Sidebar Container -->
		<aside class="main-sidebar sidebar-dark-primary elevation-4">
			<!-- Brand Logo -->
			<a href="../../index3.html" class="brand-link">
				<img src="/logo_buildoc_icono_blanco.png" alt="Buildoc Logo" class="brand-image  " style="opacity: .8">
				<span class="brand-text font-weight-light">Servinco SAS</span>
			</a>

			<!-- Sidebar -->
			<div class="sidebar">
				<!-- Sidebar user (optional) -->
				<div class="user-panel mt-3 pb-3 mb-3 d-flex">
					<div class="image">
						<img src="/user.png" class="img-circle elevation-2" alt="User Image">
					</div>
					<div class="info">
						<a href="#" class="d-block"> @UserManager.GetUserName(User)!</a>
					</div>
				</div>

				<!-- SidebarSearch Form -->
				<div class="form-inline">
					<div class="input-group" data-widget="sidebar-search">
						<input class="form-control form-control-sidebar" type="search" placeholder="Buscar" aria-label="Search">
						<div class="input-group-append">
							<button class="btn btn-sidebar">
								<i class="fas fa-search fa-fw"></i>
							</button>
						</div>
					</div>
				</div>

				<!-- Sidebar Menu -->
				<nav class="mt-2">
					<ul class="nav nav-pills nav-sidebar flex-column" data-widget="treeview" role="menu" data-accordion="false">
						<!-- Add icons to the links using the .nav-icon class
							 with font-awesome or any other icon font library -->
						@if (SignInManager.IsSignedIn(User))
						{

							@if (User.IsInRole("Administrador"))
							{

								<li class="nav-item">
									<a asp-action="Index" asp-controller="Usuarios" class="nav-link">
										<i class="nav-icon fas fa-users"></i>
										<p>
											Usuarios
										</p>
									</a>
								</li>
							}
							else if (User.IsInRole("Coordinador"))
							{

								<li class="nav-item">
									<a href="@Url.Action("Index", "Proyectos")" class="nav-link">
										<i class="nav-icon fas fa-building"></i>
										<p>
											Proyectos

										</p>
									</a>
								</li>

								<li class="nav-item">
									<a href="@Url.Action("Index", "Proyectos")" class="nav-link">
										<i class="nav-icon fas fa-building"></i>
										<p>
											Inpecciones

										</p>
									</a>
								</li>
								<li class="nav-item menu-open">
									<a href="#" class="nav-link active">
									  <i class="nav-icon fas fa-tachometer-alt"></i>
									  <p>
										Incidentes
										<i class="right fas fa-angle-left"></i>
									  </p>
									</a>
									<ul class="nav nav-treeview">
									  <li class="nav-item">
										<a href="@Url.Action("Index", "TipoIncidentes")" class="nav-link active">
										  <i class="far fa-circle nav-icon"></i>
										  <p>Tipo de incidentes</p>
										</a>
									  </li>
									  <li class="nav-item">
											<a href="@Url.Action("Index", "Incidentes")" class="nav-link">
										  <i class="far fa-circle nav-icon"></i>
										  <p>Reportar Incidente</p>
										</a>
									  </li>
									</ul>
								</li>
								<li class="nav-item">
									<a href="@Url.Action("Index", "Proyectos")" class="nav-link">
										<i class="nav-icon fas fa-building"></i>
										<p>
											Incidentes
										</p>
									</a>
								</li>
							}
							else if (User.IsInRole("Residente"))
							{

								<li class="nav-item">
									<a href="@Url.Action("Index", "Proyectos")" class="nav-link">
										<i class="nav-icon fas fa-building"></i>
										<p>
											Inpecciones

										</p>
									</a>
								</li>

								<li class="nav-item">
									<a href="@Url.Action("Index", "Proyectos")" class="nav-link">
										<i class="nav-icon fas fa-building"></i>
										<p>
											Incidentes
										</p>
									</a>
								</li>
							}
						}

						<!--   <li class="nav-header">MISCELLANEOUS</li> -->

				</nav>
				<!-- /.sidebar-menu -->
			</div>
			<!-- /.sidebar -->
		</aside>

		<!-- Content Wrapper. Contains page content -->
		<div class="content-wrapper">
			<section class="content m-4 p-3">
				<div class="container-fluid">
					@RenderBody()
				</div>
			</section>
			<!-- /.modal -->

			<div class="modal fade" id="modal-lg">
				<div class="modal-dialog modal-lg">
					<div class="modal-content">
						<div class="overlay" style="display:none;" id="spinner" role="status">
							<i class="fas fa-2x fa-sync fa-spin"></i>
						</div>
						<div class="modal-header">
							<h4 class="modal-title">Large Modal</h4>
							<button type="button" class="close" data-dismiss="modal" aria-label="Close">
								<span aria-hidden="true">&times;</span>
							</button>
						</div>
						<div class="modal-body">
							<p>One fine body&hellip;</p>
						</div>
						<div class="modal-footer justify-content-between">
							<button type="button" class="btn btn-default" data-dismiss="modal">Cancelar</button>
							<button type="button" class="btn btn-primary btn-save" style="display: none;">Guardar</button>
							<button type="button" class="btn btn-danger btn-delete" style="display: none;">Eliminar</button>
							<button type="button" class="btn btn-secondary btn-edit" style="display: none;">Editar</button>
							<button type="button" class="btn btn-success btn-restore" style="display: none;">Restaurar</button>
						</div>
					</div>
					<!-- /.modal-content -->
				</div>
				<!-- /.modal-dialog -->
			</div>
			<!-- /.modal -->
			<!-- Mensajes de notificacion tipo alerts -->
			<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/js/toastr.min.js"></script>
			<script>
				$(document).ready(function () {
					// Configuración global de Toastr
					toastr.options.positionClass = 'toast-top-right'; // Posición del mensaje

                    // Mostrar Toastr si TempData contiene un mensaje de éxito
                @if (TempData["SuccessMessage"] != null)
                {
                    <text>
                            toastr.success('@TempData["SuccessMessage"]');
                    </text>
                }
                                });
            </script>
            <!-- /. Mensajes de notificacion tipo alerts -->
        <!-- /.content-wrapper -->

       

        <!-- Control Sidebar -->
        <aside class="control-sidebar control-sidebar-dark">
            <!-- Control sidebar content goes here -->
        </aside>
        <!-- /.control-sidebar -->
    </div>
    <!-- ./wrapper -->
    <!-- jQuery -->
    <script src="/AdminLTE/plugins/jquery/jquery.min.js"></script>
    <!-- Bootstrap 4 -->
    <script src="/AdminLTE/plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
    <!-- AdminLTE App -->
    <script src="/AdminLTE/js/adminlte.min.js"></script>
    <!-- AdminLTE for demo purposes -->
        <script src="/AdminLTE/js/demo.js"></script>

        <!-- jQuery Validation -->   
        <script src="/AdminLTE/plugins/jquery-validation/jquery.validate.min.js"></script>
        <script src="/AdminLTE/plugins/jquery-validation/additional-methods.min.js"></script>
        <script>
            // Función para añadir una alerta si no existe una con el mismo mensaje, o actualizarla si ya existe
            function addAlert(message, type) {
                $('#modal-lg .modal-body .alert').remove();
                $('#modal-lg .modal-body').prepend('<div class="alert alert-' + type + '">' + message + '</div>');
            }

    $(document).ready(function () {
        // Manejar el clic en los enlaces de operación (crear, editar, detalles, eliminar, restaurar)
        $(document).on('click', '.create-new, .edit-item, .details-view, .delete-item, .restore-item', function (e) {
            e.preventDefault();
            var url = $(this).data('url');
            var title = $(this).data('title');
            var action = $(this).data('action'); // 'create', 'edit', 'details', 'delete', 'restore'

            $('#modal-lg .modal-title').text(title);
            $.get(url).done(function (data) {
                $('#modal-lg .modal-body').html(data);
                $('#modal-lg').modal('show');

                // Intento de método para mostrar validaciones
                // $.validator.unobtrusive.parse($('#modal-lg'));

                // Configurar los botones del modal según la acción
                if (action === 'create' || action === 'edit') {
                    $('.btn-save').show();
                    $('.btn-delete').hide();
                    $('.btn-edit').hide();
                    $('.btn-restore').hide();
                } else if (action === 'delete') {
                    $('.btn-save').hide();
                    $('.btn-delete').show();
                    $('.btn-edit').hide();
                    $('.btn-restore').hide();
                } else if (action === 'details') {
                    $('.btn-save').hide();
                    $('.btn-delete').hide();
                    $('.btn-edit').show().data('url', url.replace('Details', 'Edit')); // Configurar el botón de editar
                    $('.btn-restore').hide();
                } else if (action === 'restore') {
                    $('.btn-save').hide();
                    $('.btn-delete').hide();
                    $('.btn-edit').hide();
                    $('.btn-restore').show();
                }
            }).fail(function () {
                console.log('Error al cargar el contenido del modal.');
            });
        });

        // Manejar la acción de guardar
        $('#modal-lg').on('click', '.btn-save', function (e) {
            e.preventDefault();

            var form = $('#modal-lg').find('form');
            if (form.length === 0) {
                console.log('No se encontró el formulario dentro del modal.');
                addAlert('No se encontró el formulario dentro del modal.', 'danger');
                return;
            }

            var formData = form.serialize();

            // Mostrar el spinner
            $("#spinner").show();

            $.ajax({
                url: form.attr('action'),
                type: form.attr('method'),
                data: formData,
                success: function (response) {
                    // Ocultar el spinner
                    $("#spinner").hide();

                    if (response.success) {
                        $('#modal-lg').modal('hide');
                        location.reload();
                    } else {
                        addAlert(response.message || 'Error no especificado.', 'danger');
                    }
                },
                error: function () {
                    // Ocultar el spinner
                    $("#spinner").hide();

                    addAlert('Se produjo un error al procesar la solicitud.', 'danger');
                }
            });
        });

        // Manejar la acción de eliminar
        $('#modal-lg').on('click', '.btn-delete', function (e) {
            e.preventDefault();

            var form = $('#modal-lg').find('form');
            if (form.length === 0) {
                console.log('No se encontró el formulario dentro del modal.');
                addAlert('No se encontró el formulario dentro del modal.', 'danger');
                return;
            }

            var formData = form.serialize();

            // Mostrar el spinner
            $("#spinner").show();

            $.ajax({
                url: form.attr('action'),
                type: form.attr('method'), // Asegúrate de que el método sea correcto para eliminar
                data: formData,
                success: function (response) {
                    // Ocultar el spinner
                    $("#spinner").hide();

                    if (response.success) {
                        $('#modal-lg').modal('hide');
                        location.reload();
                    } else {
                        addAlert(response.message || 'Error no especificado.', 'danger');
                    }
                },
                error: function () {
                    // Ocultar el spinner
                    $("#spinner").hide();

                    addAlert('Se produjo un error al procesar la solicitud.', 'danger');
                }
            });
        });

        // Manejar la acción de editar desde los detalles
        $('#modal-lg').on('click', '.btn-edit', function (e) {
            e.preventDefault();
            var editUrl = $(this).data('url');

            $.get(editUrl).done(function (data) {
                $('#modal-lg .modal-body').html(data);
                $('#modal-lg').modal('show');
                $('#modal-lg .btn-save').show();
                $('#modal-lg .btn-edit').hide();
            }).fail(function () {
                console.log('Error al cargar el contenido del modal de edición.');
            });
        });

        // Manejar la acción de restaurar
        $('#modal-lg').on('click', '.btn-restore', function (e) {
            e.preventDefault();

            var form = $('#modal-lg').find('form');
            if (form.length === 0) {
                console.log('No se encontró el formulario dentro del modal.');
                $('#modal-lg .modal-body').prepend('<div class="alert alert-danger">No se encontró el formulario dentro del modal.</div>');
                return;
            }

            var formData = form.serialize();

            // Mostrar el spinner
            $("#spinner").show();

            $.ajax({
                url: form.attr('action'),
                type: form.attr('method'),
                data: formData,
                success: function (response) {
                    // Ocultar el spinner
                    $("#spinner").hide();

                    if (response.success) {
                        $('#modal-lg').modal('hide');
                        location.reload();
                    } else {
                        if ($('#modal-lg .alert.alert-danger').length === 0 ||
                            $('#modal-lg .alert.alert-danger').text().indexOf(response.message) === -1) {
                            $('#modal-lg .modal-body').prepend('<div class="alert alert-danger">' + (response.message || 'Error no especificado.') + '</div>');
                        }
                    }
                },
                error: function () {
                    // Ocultar el spinner
                    $("#spinner").hide();

                    if ($('#modal-lg .alert.alert-danger').length === 0 ||
                        $('#modal-lg .alert.alert-danger').text().indexOf('Se produjo un error al procesar la solicitud.') === -1) {
                        $('#modal-lg .modal-body').prepend('<div class="alert alert-danger">Se produjo un error al procesar la solicitud.</div>');
                    }
                }
            });
        });
    });
</script>


		<script src="/js/departamentos.js"></script>

		@* Script para la data table *@

		<script src="~/adminlte/plugins/jquery/jquery.min.js"></script>

		<!-- Bootstrap 4 -->
		<script src="/AdminLTE/plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
		<!-- DataTables  & Plugins -->
		<script src="/AdminLTE/plugins/datatables/jquery.dataTables.min.js"></script>
		<script src="/AdminLTE/plugins/datatables-bs4/js/dataTables.bootstrap4.min.js"></script>
		<script src="/AdminLTE/plugins/datatables-responsive/js/dataTables.responsive.min.js"></script>
		<script src="/AdminLTE/plugins/datatables-responsive/js/responsive.bootstrap4.min.js"></script>
		<script src="/AdminLTE/plugins/datatables-buttons/js/dataTables.buttons.min.js"></script>
		<script src="/AdminLTE/plugins/datatables-buttons/js/buttons.bootstrap4.min.js"></script>
		<script src="/AdminLTE/plugins/jszip/jszip.min.js"></script>
		<script src="/AdminLTE/plugins/pdfmake/pdfmake.min.js"></script>
		<script src="/AdminLTE/plugins/pdfmake/vfs_fonts.js"></script>
		<script src="/AdminLTE/plugins/datatables-buttons/js/buttons.html5.min.js"></script>
		<script src="/AdminLTE/plugins/datatables-buttons/js/buttons.print.min.js"></script>
		<script src="/AdminLTE/plugins/datatables-buttons/js/buttons.colVis.min.js"></script>
		<script src="/espanol.json"></script>

            

   
       
        <script>
            $(document).ready(function () {
                $('#example1').DataTable({
                    "dom":
                        "<'row'<'col-sm-6'B><'col-sm-3'><'col-sm-3'f>>" +
                        "<'row'<'col-sm-12'tr>>" +
                        "<'row'<'col-sm-5'i><'col-sm-7 text-left'p>>",

					"language": {
						"url": "/espanol.json"
					},
					"responsive": true,
					"lengthChange": false,
					"autoWidth": false,
					"paging": true,
					"ordering": true,
					"info": true,

					"buttons": ["csv", "excel", "pdf", "colvis"]
				}).buttons().container().appendTo('#example1_wrapper .col-md-6:eq(0)');


			});
		</script>

		@RenderSection("Scripts", required: false)
		<!-- Toastr script -->
		<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/js/toastr.min.js"></script>
		<script>
			$(document).ready(function () {
				// Configuración global de Toastr
				toastr.options.positionClass = 'toast-top-right'; // Posición del mensaje

				// Mostrar Toastr si TempData contiene un mensaje de éxito
			@if (TempData["SuccessMessage"] != null)
			{
				<text>
						toastr.success('@TempData["SuccessMessage"]');
				</text>
			}
													});
		</script>

</body>
</html>
